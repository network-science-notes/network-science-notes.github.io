{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
        "code-fold: true\n",
        "code-summary: \"Show code\"\n",
        "jupyter: python3\n",
        "---\n",
        "\n",
        "\n",
        "# Probability Generating Functions\n",
        "\n",
        "In this lecture we'll introduce a powerful tool for calculating network properties: probability generating functions.\n",
        "\n",
        "## Properties of probability generating functions\n",
        "\n",
        "::: {.callout-note icon=false appearance=\"minimal\"}\n",
        "::: {#def-pgf}\n",
        "\n",
        "Let $K$ be the random variable denoting node degree, with degree distribution $p_k$.  The **probability generating function** $g(z)$ is given by\n",
        "\n",
        "$$\n",
        "    g(z) = p_0 + p_1z + p_2z^2 + \\dots = \\sum_{k=0}^\\infty p_kz^k \\,.\n",
        "$$\n",
        "\n",
        ":::\n",
        ":::\n",
        "\n",
        "We note that the degree distribution and the probability generating function give two different mathematical representations of the same idea. The probability generating function is a **power series** representation of the degree distribution of $K$. This is quite useful because the probability generating function is always a polynomial, and there is a lot of rich theory we can leverage.\n",
        "\n",
        "::: {.callout-caution}\n",
        "**Exercise**: Suppose we have a network where we observe the following data.\n",
        "\n",
        "| Node Degree | Percentage of Nodes with Given Degree|\n",
        "| ------ | ----- |\n",
        "| 0 | 12% |\n",
        "| 1 | 20% |\n",
        "| 2 | 58% |\n",
        "| 3 | 10% |\n",
        "\n",
        "What is the probability generating function $g(z)$ associated with the degree distribution for this network? \n",
        ":::\n",
        "\n",
        "::: {.hide .solution}\n",
        "The probability that a node has degree $k$ in our network is equal to the fraction of nodes with that degree. Therefore, we have\n",
        "$$\n",
        "    g(z) = 0.12 + .2z + 0.58z^2 + .1 z^3 \\,,\n",
        "$$\n",
        "noting that $p_k = 0$ for $k>3.$\n",
        ":::\n",
        "\n",
        "::: {.callout-caution}\n",
        "**Exercise**: Suppose $K$ is Poisson distributed with mean degree $c$. What is the probability generating function for $K$?\n",
        "\n",
        "*Recall that the probability mass function a Poisson distribution with mean $c$ is given by $\\frac{c^k e^{-c}}{k!}.$*\n",
        ":::\n",
        "\n",
        "::: {.hide .solution}\n",
        "Substituting $p_k = \\frac{c^k e^{-c}}{k!}$ into the formula above yields the probability generating function\n",
        "\\begin{align*}\n",
        "    g(z) &= \\sum_{k=0}^\\infty e^{-c}\\frac{c^k}{k!}z^k \\\\\n",
        "        &= e^{-c}\\sum_{k=0}^\\infty\\frac{c^k}{k!}z^k \\\\\n",
        "        &= e^{-c} e^{cz} \\\\\n",
        "        &= e^{c(z-1)} \\,,\n",
        "\\end{align*}\n",
        "where in the third line we have used the Taylor series\n",
        "$$\n",
        "e^{x} = \\sum_{k=0}^\\infty \\frac{x^k}{k!} \\,.  \n",
        "$$ \n",
        "\n",
        "This series converges for all (finite) values of $c$ and $k$.\n",
        ":::\n",
        "\n",
        "::: {.callout-caution}\n",
        "**Exercise**: What is the probability generating function for the exponential distribution of the form\n",
        "$$\n",
        "    p_k = (1-a)a^k, \\quad 0<a<1 \\,.\n",
        "$$\n",
        ":::\n",
        "\n",
        "::: {.hide .solution}\n",
        "Substituting $p_k = (1-a)a^k$ into the formula above yields the probability generating function\n",
        "$$\n",
        "    g(z) = (1-a)\\sum_{k=0}^\\infty \\left(az \\right)^k \\,.\n",
        "$$\n",
        "\n",
        "However, notice that this series diverges if $az \\geq 1$, that is, if $z \\geq \\frac{1}{a}.$ Thus, we have\n",
        "$$\n",
        "    g(z) = \\frac{1-a}{1-az}, \\quad \\vert z \\vert <\\frac{1}{a}.\n",
        "$$\n",
        ":::\n",
        "\n",
        "The examples above give a sense of how to calculate probability generating functions from known degree distributions. As the next theorem shows, we can also find the degree distribution from the probability generating function. We'll prove this theorem in class.\n",
        "\n",
        "::: {.callout-tip icon=false collapse=true}\n",
        "::: {#thm-pgf}\n",
        "Let $g(z)$ be the probability generating function associated with random variable $K$. Then the associated probability distribution $p_k$ satisfies\n",
        "$$\n",
        "p_k = \\frac{1}{k!}\\frac{d^k}{dz^k}g(z) \\bigg \\vert_{z=0} \n",
        "$$\n",
        "for all $k = 0, 1, 2, \\dots \\,.$\n",
        ":::\n",
        ":::\n",
        "\n",
        "::: {.hide .proof}\n",
        "We know that $g(z)$ is a polynomial, and thus infinitely differentiable. Using the power rule for polynomial differentiation, the $k$th derivative of $g$ with respect to $z$ satisfies\n",
        "$$\n",
        "g^{(k)}(z) = k!p_k + \\frac{(k+1)}{1!}p_{k+1}z + \\frac{(k+2)}{2!}p_{k+2}z^2 + \\dots \\,.\n",
        "$$\n",
        "If we evaluate at $g=0$, all terms except the first will vanish:\n",
        "$$\n",
        "g^{(k)}(0) = k!p_k \\,. \n",
        "$$\n",
        "\n",
        "Solving for $p_k$ gives the desired result.\n",
        ":::\n",
        "\n",
        "## Normalization and moments\n",
        "\n",
        "The **moments** of a probability distribution are quantities that give us important information about the shape of the distribution. The $m$th moment of a probability distribution $p_k$ is\n",
        "\n",
        "$$\n",
        " \\langle k^m \\rangle = \\sum_{k=0}^\\infty k^m p_k \\,. \n",
        "$$\n",
        "\n",
        "We recognize that moments have already shown up in several of our calculations thus far. For example, the zeroth moment of a degree distribution is always 1 since $\\sum_{k=0}^\\infty p_k = 1$. The first moment $\\langle k \\rangle$ is the expected value. The second moment showed up in our previous lecture when discussing the friendship paradox.\n",
        "\n",
        "We can now see that generating functions give us a nice way to calculate moments. Using the definition of the probability generating function, we see that the zeroth moment is given by\n",
        "$$\n",
        "    g(1) = \\sum_{k=0}^\\infty p_k = 1 \\,.\n",
        "$$\n",
        "If we take the derivative of the probability generating function with respect to $z$ we obtain\n",
        "$$\n",
        "    g'(z) = \\sum_{k=0}^\\infty kp_kz^{k-1} \\,.\n",
        "$$\n",
        "If we evaluate at $z=1$, we get the first moment of $p_k$:\n",
        "$$\n",
        "    g'(1) = \\sum_{k=0}^\\infty kp_k = \\langle k \\rangle\\,.\n",
        "$$\n",
        "\n",
        "Unfortunately, we can see that $g''(1)$ will not exactly give us the second moment. A small modification, however, will do the trick. \n",
        "\n",
        "\\begin{align*}\n",
        "    z \\frac{d}{dz} \\left(z \\frac{dg}{dz}\\right) &=  z \\frac{d}{dz} \\left( \\sum_{k=0}^\\infty kp_kz^{k} \\right) \\\\\n",
        "    &= z \\sum_{k=0}^\\infty k^2p_kz^{k-1} \\\\\n",
        "    &= \\sum_{k=0}^\\infty k^2p_kz^{k} \\,.\n",
        "\\end{align*}\n",
        "\n",
        "Evaluating this quantity at $z=1$ will give the second moment of the distribution:\n",
        "$$\n",
        "    \\left( z \\frac{d}{dz} \\right)^2 g(z) \\bigg \\vert_{z=1} = \\langle k^2 \\rangle \\,.\n",
        "$$\n",
        "\n",
        "This strategy generalizes to higher-order moments as well.\n",
        "\n",
        "::: {.callout-note icon=false appearance=\"minimal\"}\n",
        "::: {#def-moments}\n",
        "\n",
        "Let $K$ be the random variable denoting node degree with probability generating function $g(z)$. The **$m$th moment** of the distribution of $K$ is given by\n",
        "$$\n",
        "    \\langle k^m \\rangle = \\left( z \\frac{d}{dz} \\right)^m g(z) \\bigg \\vert_{z=1} \\,.\n",
        "$$ \n",
        "\n",
        ":::\n",
        ":::\n",
        "\n",
        "## Products of generating functions\n",
        "\n",
        "In this section, we will show the following very useful property of generating functions.\n",
        "\n",
        "::: {.callout-note icon=false appearance=\"minimal\"}\n",
        "::: {#thm-multiplicative}\n",
        "\n",
        "Let $K_1, \\dots, K_m$ be independent and identically distributed (i.i.d.) random variables drawn from probability distributions $p_k^{(1)}, p_k^{(2)}, \\dots, p_k^{(m)}$ with corresponding probability generating functions $g_1(z), \\dots g_m(z)$. Then $X = \\sum_{i=1}^m K_i$ has the generating function $g_X(z) = \\prod_{i=1}^m g_i(z)$.\n",
        "\n",
        ":::\n",
        ":::\n",
        "\n",
        "::: {.proof}\n",
        "Since $K_i$ are i.i.d, the probability of drawing a particular set of values $\\mathcal{K} = \\{k_1, k_2, \\dots, k_m\\}$ is \n",
        "$$\n",
        "    (p_{k_1}^{(1)})(p_{k_2}^{(2)}) \\dots (p_{k_m}^{(m)}) =  \\prod_{i=1}^m p_{k_i}^{(i)} \\,.\n",
        "$$ \n",
        "\n",
        "Next, we will calculate the probability $\\pi_s$ that the values add to a specific total $s$. We do this by summing the product over all sets $\\mathcal{K}$ that add to $s$.\n",
        "\n",
        "$$\n",
        "    \\pi_s = \\sum_{k_1=0}^ \\infty \\dots \\sum_{k_m=0}^ \\infty \\delta_{s, \\sum_i k_i} \\prod_{i=1}^m p_{k_i}^{(i)}\\,.\n",
        "$$\n",
        "where $\\delta_{s, \\sum_i k_i}$ is the Kronecker delta.\n",
        "\n",
        "Now that we have this probability, we can write down a probability generating function for the distribution $\\pi_s$:\n",
        "\n",
        "\\begin{align*}\n",
        "    h(z) &= \\sum_{s=0}^\\infty \\pi_s z^s \\\\\n",
        "    &= \\sum_{s=0}^\\infty z^s \\left[ \\sum_{k_1=0}^\\infty \\dots \\sum_{k_m=0}^\\infty \\delta_{s, \\sum_i k_i} \\prod_{i=1}^m p_{k_i}^{(i)} \\right] \\,.\n",
        "\\end{align*}\n",
        "\n",
        "Since $s= \\sum_i k_i$ for each case, we can rewrite the above as\n",
        "\\begin{align*}\n",
        "    h(z) &= \\sum_{k_1=0}^\\infty \\dots \\sum_{k_m=0}^\\infty z^{\\sum_i k_i}\\prod_{i=1}^m p_{k_i}^{(i)} \\\\\n",
        "    &= \\prod_{i=1}^m \\sum_{k_i = 0}^\\infty p_{k_i}^{(i)} z^{k_i} \\,.\n",
        "\\end{align*}\n",
        "\n",
        "But, simplifying the notation on the indices, we see that $\\sum_{k_i = 0}^\\infty p_{k_i}^{(i)} z^{k_i} = \\sum_{k = 0}^\\infty p_{k}^{(i)} z^{k} = g_i(z).$ \n",
        "\n",
        "Thus,\n",
        "$$\n",
        "    h(z) = \\prod_{i=1}^m g_i(z) \\,\n",
        "$$\n",
        "as required.\n",
        "\n",
        ":::\n",
        "\n",
        "This theorem has a very useful corollary in the case where all the random variables are drawn from the same distribution.\n",
        "\n",
        "::: {.callout-note icon=false appearance=\"minimal\"}\n",
        "**Corollary**. If $K_1, \\dots, K_m$ are independent and identically distributed (i.i.d.) random variables drawn from the same probability distribution $p_k$, then the sum $X = \\sum_{i=1}^m K_i$ has the generating function $(g(z))^m$, where $g(z)$ is the probability generating function for $p_k.$\n",
        ":::\n",
        "\n",
        "This corollary is useful when summing the degrees of $m$ randomly chosen nodes from degree distribution $p_k$. \n",
        "\n",
        "## Applications in configuration Models\n",
        "\n",
        "### Generating functions for excess degree distribution\n",
        "\n",
        "Suppose we have a random graph $G$ generated by a configuration model with degree distribution $p_k$. That is, we know if we select a node $u$ from $G$ uniformly at random, it will have degree $k$ with probability $p_k,$ and the associated generating function is $g_K(z)$. \n",
        "\n",
        "We showed previously that the excess degree distribution is $q_k = \\frac{(k+1)p_{k+1}}{c},$ where $c = \\mathbb{E}(K)$ is the expected degree of the network. Here, we use the notation $J$ for the random variable for excess degree of node $u$, which means that $J+1$ describes degree of a node reached by following an edge in $G$. From here, we can write down the generating function $g_J$ for the excess degree:\n",
        "\\begin{align}\n",
        "    g_J(z) &= \\sum_{k=0}^\\infty q_k z^k \\\\\n",
        "    &= \\sum_{k=0}^\\infty \\frac{(k+1)p_{k+1}}{c} z^k \\\\\n",
        "    &= \\frac{1}{c}\\sum_{k=0}^\\infty (k+1)p_{k+1}z^k\n",
        "\\end{align}\n",
        "\n",
        "If we compare the last line to the formula for $g'(z)$ above, we see that this looks like the derivative of the generating function associated with $p_k$ ... cool!\n",
        "$$\n",
        "    g_J(z) = \\frac{1}{c} g'_K(z) \\,.\n",
        "$$\n",
        "We can make one final note: since $c = \\mathbb{E}(K) = g'_K(1)$, we can also write the denominator in terms of generating functions for $K$:\n",
        "$$\n",
        "    g_J(z) = \\frac{g'_K(z)}{g_K'(1)} \\,.\n",
        "$$\n",
        "\n",
        "Thus, we have a relationship between generating functions for the degree distribution and the excess degree distribution.\n",
        "\n",
        "### Number of second neighbors of a node {#sec-secondneighbors}\n",
        "\n",
        "Now, suppose we have a configuration model with degree distribution $p_k$ under the assumption that the network is locally tree-like. We know how to count the number of neighbors (that's given by the degree). Let's count the number of neighbors of neighbors --- also called second neighbors --- of a node. \n",
        "\n",
        "What is the probability that a node has exactly $k$ second neighbors in our configuration model? It depends on how many neighbors you have! If you have $m$ neighbors, then this probability is\n",
        "$$\n",
        "    \\mathbb{P}(m \\text{ neighbors})\\mathbb{P}(k \\text{ second neighbors} \\vert m \\text{ neighbors}) \\,.\n",
        "$$\n",
        "\n",
        "Summing over all possible values of $m$ gives us our expression:\n",
        "$$\n",
        "     \\mathbb{P}(k \\text{ second neighbors}) = \\sum_{m=0}^\\infty \\mathbb{P}(m \\text{ neighbors})\\mathbb{P}(k \\text{ second neighbors} \\vert m \\text{ neighbors})\n",
        "$$\n",
        "\n",
        "This calculation could be very hard! Let's see how generating functions can help us perform this calculation. We will define the generating function for $\\mathbb{P}(k \\text{ second neighbors})$ to be $g_2(z).$ Then\n",
        "\n",
        "\\begin{align}\n",
        "    g_2(z) &= \\sum_{k=0}^\\infty \\mathbb{P}(k \\text{ second neighbors}) z^k \\\\\n",
        "    &= \\sum_{k=0}^\\infty \\sum_{m=0}^\\infty p_m \\mathbb{P}(k \\text{ second neighbors} \\vert m \\text{ neighbors}) z^k \\\\\n",
        "    & = \\sum_{m=0}^\\infty p_m \\sum_{k=0}^\\infty \\mathbb{P}(k \\text{ second neighbors} \\vert m \\text{ neighbors}) z^k \\,.\n",
        "\\end{align}\n",
        "\n",
        "However, notice that the quantity $\\mathbb{P}(k \\text{ second neighbors} \\vert m \\text{ neighbors})$ is related to the excess degree: we are interested in the sum of the excess degrees of $m$ neighbors. Using the multiplicative property we proved above, we know that this sum has the generating function $(g_J(z))^m$.\n",
        "\n",
        "$$\n",
        "     \\sum_{k=0}^\\infty \\mathbb{P}(k \\text{ second neighbors} \\vert m \\text{ neighbors}) z^k = \\prod_{i=1}^m\\sum_{k=0}^\\infty q_kz^k = (g_J(z))^m\\,.\n",
        "$$\n",
        "\n",
        "Substituting this expression into our calculation for $g_2(z)$ yields\n",
        "$$\n",
        "g_2(z) = \\sum_{m=0}^\\infty p_m (g_J(z))^m = g_K(g_J(z)) \\,.\n",
        "$$\n",
        "\n",
        "That is, the generating function for the distribution of second neighbors can be calculated from the generating functions of the degree and excess degree distribution!\n",
        "\n",
        "We can now find the expected number of second neighbors by calculating $g_2'(1)$. By the chain rule, $g_2'(z) = g_K'(g_J(z))g_J'(z).$ \n",
        "\n",
        "$$\n",
        "    g_2'(1) = g_K'(g_J(1))g_J'(1).\n",
        "$$\n",
        "\n",
        "However, we know that $g_J(1) = 1$, because it is the zeroth moment of the distribution. Thus,\n",
        "$$\n",
        "    \\mathbb{E}(\\text{second neighbors}) = g_K'(1)g_J'(1) = (\\text{mean degree})(\\text{mean excess degree})\\,.\n",
        "$$\n",
        "\n",
        "Referring to our previous calculations for these quantities, we have\n",
        "$$\n",
        "    \\mathbb{E}(\\text{second neighbors}) = \\langle k \\rangle \\frac{\\langle k^2 \\rangle - \\langle k \\rangle}{\\langle k \\rangle} = \\langle k^2 \\rangle - \\langle k \\rangle \\,.\n",
        "$$\n",
        "\n",
        "## References\n"
      ],
      "id": "70ccf3e6"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python3",
      "language": "python",
      "display_name": "Python 3 (ipykernel)",
      "path": "/Users/philchodrow/opt/anaconda3/envs/ml-0451/share/jupyter/kernels/python3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}